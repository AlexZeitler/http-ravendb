<html>
  <style type="text/css">
    .rounded-corners {
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      -khtml-border-radius: 5px;
      border-radius: 5px;
    }
    html, body {
      height: 100%;
      padding: 0;
      margin: 0;
      font-family: Helvetica, Arial, freesans, clean, sans-serif;
    }
    header {
      height: 35px;
      padding: 10px 0px 5px 10px;
    }
    #content {
      height: 100%;
      margin-bottom: -55px;
      position: relative;
    }
    footer {
      height: 35px;
      position: relative;
      padding: 10px 0px 5px 10px;
      background-color: #888;
      border-top: solid 3px #333;
    }
    ul {
      list-style: none;
      display: inline;
      width: 100%;
    }
    ul li, ul article, ul .count, ul.id {
      display: inline;
    }
    ul li {
      margin: 10px;
      float: left;
      height: 50px;
      border: solid 1px #333;
      background-color: #eee;
      width: 150px;
    }
    ul li .collection {
      height: 40px;
      width: 10px;
      float: left;
      margin-top: 5px;
      margin-left: 5px;
      margin-right: 5px;
    }
    ul li article {
      float: left;
      margin-right: 5px;
    }
    ul h3 {
      margin: 5px;
      margin-bottom: 0px;
    }
    ul .count {
      font-style: italic;
      font-size: 83%;
      color: #555;
      margin-left: 5px;
    }
    .collection { background-color: #aaa; }
    .collection-1 { background-color: green; }
    .collection-2 { background-color: purple; }
    .collection-3 { background-color: red; }
    .collection-4 { background-color: blue;}

    #documents, #collections { 
      display: block;
      clear: both;
    }
    #documents ul h3 {
      font-size: 100%;
      font-weight: normal;
    }
    #documents ul .id {
      margin-left: 5px;
    }
  </style>
  <body>
    <div id="content">
      <header>
        <input id="url" type="text" value="http://localhost/ravendb"></input>
        <button id="connect">Connect</button>
      </header>

      <div id="collections">
        <ul>
        </ul>
      </div>

      <div id="documents">
        <ul>
        </ul>
      </div>
    </div>

    <footer>
      <div id="stats">
        Statistics:&nbsp;&nbsp;
        <span id="docs"></span> documents &nbsp;&nbsp;
        <span id="indexes"></span> indexes &nbsp;&nbsp;
        <span id="stale"></span> stale &nbsp;&nbsp;
        <span id="errors"></span> errors &nbsp;&nbsp;
        <span id="triggers"></span> triggers &nbsp;&nbsp;
        <span id="tasks"></span> tasks &nbsp;&nbsp;
      </div>
    </footer>

    <script src="./jquery.js"></script>
    <script src="./ravendb.js"></script>
    <script>
    window.db = null
    var connect = function(url, db) {
      var ravendb = require('ravendb')
      window.db = ravendb(url, db)
    }

    var countForCollection = function(collection) {
      db.getDocumentCount(collection.name, function(err, count) {
        $('#collections ul').append('<li class="rounded-corners"><div class="collection collection-' + collection.number + '"></div><article><h3>' + collection.name + '</h3><div class="count">' + count + '</div></li>')  
      })
    }

    var collections = function() {
      $('#collections ul').html('')

      db.getCollections(function(err, results) {
       for(var i=0; i < results.length; i++) {
          var collection = { name: results[i], number: i+1 }
          countForCollection(collection)
        }
      })
    }


    var documents = function(collection) {
      var name = collection && collection.name ? collection.name : null
      $('#documents ul').html('')

      db.getDocsInCollection(name, function(err, results) {  // still need to do start/count
        var documents = results
        console.log(documents)
        for(var i=0; i < documents.length; i++) {
          var doc = { collection: documents[i]['@metadata']['Raven-Entity-Name'], id: documents[i]['@metadata']['@id'] }
          $('#documents ul').append('<li class="rounded-corners"><div class="collection collection-' + doc.collection + '"></div><article><h3>' + doc.collection + '</h3><div class="id">' + doc.id + '</div></li>')
        }
      })
    }


    var statistics = function(callback) {
      db.getStats(function(err, stats) {
        $('#docs').text(stats.CountOfDocuments)
        $('#indexes').text(stats.CountOfIndexes)
        $('#stale').text(stats.StaleIndexes.length)
        $('#errors').text(stats.Errors.length)
        $('#triggers').text(stats.Triggers.length)
        $('#tasks').text(stats.ApproximateTaskCount)
        
        if (callback) callback()
      })
    }


    $(function() {
      $('#connect').click(function() {
        document.body.style.cursor = 'wait'
        connect($('#url').val())
        collections()
        documents()
        statistics(function() { document.body.style.cursor = 'default' })
      })
    })
    </script>
  </body>
</html>